{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Desktop/IMAGE%20EDITOR/Image_Editor/backend/lib/cloudinary.ts"],"sourcesContent":["import { v2 as cloudinary } from 'cloudinary';\n\n// Configure Cloudinary\ncloudinary.config({\n  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\n  api_key: process.env.CLOUDINARY_API_KEY,\n  api_secret: process.env.CLOUDINARY_API_SECRET\n});\n\nexport default cloudinary;\n\n// Helper function to create folder structure in Cloudinary\nexport async function createCloudinaryFolder(folderPath: string) {\n  // Cloudinary creates folders automatically when you upload to them\n  // We'll upload a small transparent 1x1 PNG placeholder\n  const placeholderImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';\n  \n  try {\n    const result = await cloudinary.uploader.upload(placeholderImage, {\n      folder: folderPath,\n      public_id: '.folder_marker',\n      overwrite: true,\n      invalidate: true,\n      resource_type: 'image'\n    });\n    return { success: true, public_id: result.public_id };\n  } catch (error: any) {\n    console.error(`Error creating folder ${folderPath}:`, error);\n    return { success: false, error: error.message };\n  }\n}\n\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,uBAAuB;AACvB,mHAAU,CAAC,MAAM,CAAC;IAChB,YAAY,QAAQ,GAAG,CAAC,qBAAqB;IAC7C,SAAS,QAAQ,GAAG,CAAC,kBAAkB;IACvC,YAAY,QAAQ,GAAG,CAAC,qBAAqB;AAC/C;uCAEe,mHAAU;AAGlB,eAAe,uBAAuB,UAAkB;IAC7D,mEAAmE;IACnE,uDAAuD;IACvD,MAAM,mBAAmB;IAEzB,IAAI;QACF,MAAM,SAAS,MAAM,mHAAU,CAAC,QAAQ,CAAC,MAAM,CAAC,kBAAkB;YAChE,QAAQ;YACR,WAAW;YACX,WAAW;YACX,YAAY;YACZ,eAAe;QACjB;QACA,OAAO;YAAE,SAAS;YAAM,WAAW,OAAO,SAAS;QAAC;IACtD,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,CAAC,sBAAsB,EAAE,WAAW,CAAC,CAAC,EAAE;QACtD,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;IAChD;AACF","debugId":null}},
    {"offset": {"line": 65, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Desktop/IMAGE%20EDITOR/Image_Editor/backend/pages/api/organization/%5BorgName%5D/upload.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\nimport cloudinary from '@/lib/cloudinary';\n\nexport default async function handler(\n  req: NextApiRequest,\n  res: NextApiResponse\n) {\n  // Handle CORS preflight\n  if (req.method === 'OPTIONS') {\n    res.setHeader('Access-Control-Allow-Origin', '*');\n    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');\n    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');\n    res.status(200).end();\n    return;\n  }\n\n  // Set CORS headers for actual request\n  res.setHeader('Access-Control-Allow-Origin', '*');\n  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');\n  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');\n\n  if (req.method !== 'POST') {\n    res.setHeader('Allow', ['POST', 'OPTIONS']);\n    return res.status(405).end(`Method ${req.method} Not Allowed`);\n  }\n\n  try {\n    const { orgName } = req.query;\n    const { imageUrl, type, sceneData } = req.body; // type: 'editor' or 'mindmapping', sceneData: JSON string of Excalidraw scene\n    \n    if (!orgName || typeof orgName !== 'string') {\n      return res.status(400).json({ error: 'Organization name is required' });\n    }\n    \n    if (!imageUrl) {\n      return res.status(400).json({ error: 'Image URL is required' });\n    }\n    \n    const folderPath = type ? `${orgName}/${type}` : orgName;\n    \n    // Upload image to Cloudinary first\n    const uploadOptions: any = {\n      folder: folderPath,\n      use_filename: true,\n      unique_filename: true\n    };\n    \n    const result = await cloudinary.uploader.upload(imageUrl, uploadOptions);\n    \n    // Handle scene data - store as separate raw file if provided\n    let sceneDataUrl = null;\n    if (sceneData && typeof sceneData === 'string' && sceneData.length > 0) {\n      try {\n        // Store scene data as a separate raw text file in Cloudinary\n        // Use the image's public_id as part of the scene file name for association\n        const sceneFileName = `${result.public_id}_scene`;\n        const sceneDataResult = await cloudinary.uploader.upload(`data:text/plain;base64,${Buffer.from(sceneData).toString('base64')}`, {\n          folder: folderPath,\n          public_id: sceneFileName,\n          resource_type: 'raw',\n          format: 'txt',\n          overwrite: true\n        });\n        sceneDataUrl = sceneDataResult.secure_url;\n      } catch (sceneError) {\n        console.warn('Failed to store scene data separately:', sceneError);\n        // If storing separately fails, try to store in context (limited size)\n        if (sceneData.length <= 2000) {\n          try {\n            await cloudinary.uploader.add_context({\n              context: { sceneData: sceneData },\n              public_ids: [result.public_id]\n            });\n            sceneDataUrl = sceneData; // Return the data directly if small enough\n          } catch (contextError) {\n            console.warn('Failed to store scene data in context:', contextError);\n          }\n        }\n      }\n    }\n    \n    res.json({\n      id: result.public_id,\n      url: result.secure_url,\n      thumbnail: cloudinary.url(result.public_id, {\n        width: 200,\n        height: 200,\n        crop: 'fill',\n        quality: 'auto'\n      }),\n      format: result.format,\n      width: result.width,\n      height: result.height,\n      sceneData: sceneDataUrl\n    });\n  } catch (error: any) {\n    console.error('Error uploading image:', error);\n    res.status(500).json({ error: 'Failed to upload image', message: error.message });\n  }\n}\n\n"],"names":[],"mappings":";;;;AACA;;AAEe,eAAe,QAC5B,GAAmB,EACnB,GAAoB;IAEpB,wBAAwB;IACxB,IAAI,IAAI,MAAM,KAAK,WAAW;QAC5B,IAAI,SAAS,CAAC,+BAA+B;QAC7C,IAAI,SAAS,CAAC,gCAAgC;QAC9C,IAAI,SAAS,CAAC,gCAAgC;QAC9C,IAAI,MAAM,CAAC,KAAK,GAAG;QACnB;IACF;IAEA,sCAAsC;IACtC,IAAI,SAAS,CAAC,+BAA+B;IAC7C,IAAI,SAAS,CAAC,gCAAgC;IAC9C,IAAI,SAAS,CAAC,gCAAgC;IAE9C,IAAI,IAAI,MAAM,KAAK,QAAQ;QACzB,IAAI,SAAS,CAAC,SAAS;YAAC;YAAQ;SAAU;QAC1C,OAAO,IAAI,MAAM,CAAC,KAAK,GAAG,CAAC,CAAC,OAAO,EAAE,IAAI,MAAM,CAAC,YAAY,CAAC;IAC/D;IAEA,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,IAAI,KAAK;QAC7B,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,SAAS,EAAE,GAAG,IAAI,IAAI,EAAE,8EAA8E;QAE9H,IAAI,CAAC,WAAW,OAAO,YAAY,UAAU;YAC3C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAgC;QACvE;QAEA,IAAI,CAAC,UAAU;YACb,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAwB;QAC/D;QAEA,MAAM,aAAa,OAAO,GAAG,QAAQ,CAAC,EAAE,MAAM,GAAG;QAEjD,mCAAmC;QACnC,MAAM,gBAAqB;YACzB,QAAQ;YACR,cAAc;YACd,iBAAiB;QACnB;QAEA,MAAM,SAAS,MAAM,gIAAU,CAAC,QAAQ,CAAC,MAAM,CAAC,UAAU;QAE1D,6DAA6D;QAC7D,IAAI,eAAe;QACnB,IAAI,aAAa,OAAO,cAAc,YAAY,UAAU,MAAM,GAAG,GAAG;YACtE,IAAI;gBACF,6DAA6D;gBAC7D,2EAA2E;gBAC3E,MAAM,gBAAgB,GAAG,OAAO,SAAS,CAAC,MAAM,CAAC;gBACjD,MAAM,kBAAkB,MAAM,gIAAU,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,uBAAuB,EAAE,OAAO,IAAI,CAAC,WAAW,QAAQ,CAAC,WAAW,EAAE;oBAC9H,QAAQ;oBACR,WAAW;oBACX,eAAe;oBACf,QAAQ;oBACR,WAAW;gBACb;gBACA,eAAe,gBAAgB,UAAU;YAC3C,EAAE,OAAO,YAAY;gBACnB,QAAQ,IAAI,CAAC,0CAA0C;gBACvD,sEAAsE;gBACtE,IAAI,UAAU,MAAM,IAAI,MAAM;oBAC5B,IAAI;wBACF,MAAM,gIAAU,CAAC,QAAQ,CAAC,WAAW,CAAC;4BACpC,SAAS;gCAAE,WAAW;4BAAU;4BAChC,YAAY;gCAAC,OAAO,SAAS;6BAAC;wBAChC;wBACA,eAAe,WAAW,2CAA2C;oBACvE,EAAE,OAAO,cAAc;wBACrB,QAAQ,IAAI,CAAC,0CAA0C;oBACzD;gBACF;YACF;QACF;QAEA,IAAI,IAAI,CAAC;YACP,IAAI,OAAO,SAAS;YACpB,KAAK,OAAO,UAAU;YACtB,WAAW,gIAAU,CAAC,GAAG,CAAC,OAAO,SAAS,EAAE;gBAC1C,OAAO;gBACP,QAAQ;gBACR,MAAM;gBACN,SAAS;YACX;YACA,QAAQ,OAAO,MAAM;YACrB,OAAO,OAAO,KAAK;YACnB,QAAQ,OAAO,MAAM;YACrB,WAAW;QACb;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,0BAA0B;QACxC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;YAA0B,SAAS,MAAM,OAAO;QAAC;IACjF;AACF","debugId":null}}]
}